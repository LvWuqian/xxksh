<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Treemap可视化与交互</title>
    <style type="text/css">
/* form {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

svg {
  font: 10px sans-serif;
} */
    g[transform]:hover rect{ 
        fill:blue;
    }

    /* 登陆框主体 */
    .login{
        position: fixed;
        width: 512px;
        height: 284px;
        z-index: 9999;
        display: none;
        background-color: white;
        /* 这里要注意绝对定位的盒子怎么在屏幕显示居中 */
        left: 50%;
        margin-left: -256px;
        margin-top: 142px;
        border: 1px solid gray;
    }
    /* 登陆框标题 */
    .login-title{
        width: 100%;
        height: 40px;
        line-height: 40px;
        text-align: center;
        margin-bottom: 20px;
        cursor: move;
    }
    .login-title span a{
        text-decoration: none;
        border: 1px solid gray;
        font-size: 12px;
        color: black;
        border-radius: 20px;
        width: 40px;
        height: 40px;
        background-color: #fff;
        position: absolute;
        top: -20px;
        right: -20px;
    }

    /* 登陆表单 */
    .login-input{
        margin: 20px 0px 30px 0px;
    }
    .login-input label{
        float: left;
        height: 35px;
        line-height: 35px;
        width: 90px;
        padding-left: 10px;
        text-align: right;
        font-size: 14px;
    }
    .login-input input.list-input{
        height: 35px;
        line-height: 35px;
        width: 350px;
        text-indent: 5px;
    }
    /* 登陆框登陆按钮 */
    .loginSubmit{
        width: 260px;
        height: 40px;
        text-align: center;
        border: 1px solid gray;
        background-color: white;
        margin-left: 120px;

    }

    /* 遮盖层 */
    .bg{
        background-color: #000;
        width: 100%;
        height: 100%;
        top: 0px;
        position: fixed;
        opacity: 0.3;
        -webkit-opacity: 0.3;
        -moz-opacity: 0.3;
        display: none;
    }
    </style>
    <!-- <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src='https://d3js.org/d3.v4.min.js'></script> -->
</head>

<body>
    <!-- <svg width="2700" height="1500"></svg> -->

    <div id="login" class="login">
        <!-- 登陆框标题 -->
        <div id="login-title" class="login-title">
            登陆会员
            <span><a id="closeBtn" href="javascript:void(0)">关闭</a></span>
        </div>
        <!-- 登陆框表单 -->
        <div id="login-form">
            <div class="login-input">
                <label>登录名：</label>
                <input type="text" placeholder="请输入登录名" class="list-input"/>
            </div>

            <div class="login-input">
                <label>密   码：</label>
                <input type="password" placeholder="请输入密码" class="list-input"/>
            </div>
        </div>
        <!-- 登陆框登陆按钮 -->
        <input type="submit"  id="loginSubmit" value="登陆会员" class="loginSubmit"/>
    </div>
    <svg class="basic"></svg>
    <svg class="specific" display=none></svg>
    <!-- 遮盖层 -->
    <div id="bg" class="bg">sada</div>

    <!-- <form>
        <label><input type="radio" name="mode" value="sumBySize" checked> Size</label>
        <label><input type="radio" name="mode" value="sumByCount"> Count</label>
    </form> -->
    <script src="lib/d3.v6.min.js"></script>
    <script src="lib/d3-array.v3.min.js"></script>
    <script type="text/javascript">
        var count = 0;

        function uid(name) {
            return new Id("O-" + (name == null ? "" : name + "-") + ++count);
        }

        function Id(id) {
            this.id = id;
            this.href = new URL(`#${id}`, location) + "";
        }

        Id.prototype.toString = function() {
            return "url(" + this.href + ")";
        };
    </script>
    <script type="text/javascript">

    
        var color = d3.scaleSequential([8, 0], d3.interpolateMagma)
        var format = d3.format(",d")
        var height = 1060
        var width = 954

        // treemap = data => d3.treemap()
        //         .size([width, height])
        //         .paddingOuter(3)
        //         .paddingTop(19)
        //         .paddingInner(1)
        //         .round(true)
        //     (d3.hierarchy(data)
        //         .sum(d => d.value)
        //         .sort((a, b) => b.value - a.value))

        d3.json("data/newChina.json").then(function(data) {
            
            var treemap = d3.treemap()
                        .size([width, height])
                        .paddingOuter(3)
                        .paddingTop(19)
                        .paddingInner(1)
                        .round(true)

            var root = d3.hierarchy(data)
                        .eachBefore(function(d) { d.value = 1; })
                        .sum(d => d.children ? 0 : 1)
                        .sort((a, b) => b.height - a.height || b.value - a.value)
            
            treemap(root)
            console.log(root)
            const svg = d3.select("svg.basic")
                .attr("viewBox", [0, 0, width, height])
                .style("font", "10px sans-serif");

            const shadow = uid("shadow");

            svg.append("filter")
                .attr("id", shadow.id)
            .append("feDropShadow")
                .attr("flood-opacity", 0.3)
                .attr("dx", 0)
                .attr("stdDeviation", 3);

            const node = svg.selectAll("g")
            .data(d3.group(root, d => d.height))
            .join("g")
                .attr("filter", shadow)
            .selectAll("g")
            .data(d => d[1])
            .join("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`)
                .attr("class", d => "height_" + d.height);

            node.append("title")
                .text(d => `${d.ancestors().reverse().map(d => d.data.name).join("/")}\n${format(d.value)}`);

            node.append("rect")
                .attr("id", d => (d.nodeUid = uid("node")).id)
                .attr("fill", d => color(d.height))
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .style("opacity", function(d){return d.height < 2 ? 0.2 : 1});

            node.append("clipPath")
                .attr("id", d => (d.clipUid = uid("clip")).id)
            .append("use")
                .attr("xlink:href", d => d.nodeUid.href);

            node.append("text")
                .attr("clip-path", d => d.clipUid)
                .style("display", function(d){return d.height < 1 ? "none" : null})
                .style("opacity", function(d){return d.height == 1 ? 0.2 : null})
            .selectAll("tspan")
            .data(d => d.data.name.split(/(?=[A-Z][^A-Z])/g).concat(format(d.value)))
            .join("tspan")
                .attr("fill-opacity", (d, i, nodes) => i === nodes.length - 1 ? 0.7 : null)
                .text(d => d);

            node.filter(d => d.children).selectAll("tspan")
                .attr("dx", 3)
                .attr("y", 13);

            node.filter(d => !d.children).selectAll("tspan")
                .attr("x", 3)
                .attr("y", (d, i, nodes) => `${(i === nodes.length - 1) * 0.3 + 1.1 + i * 0.9}em`);

            node.filter(d => d.children || !d.children)
                .attr("cursor", "pointer")
                .on("click", (event, d) => enlarge(d));

            // return svg.node();
        });
        
        function enlarge(r){
            console.log(r)
            // 悬浮窗
            // login.style.display="block";
            // bg.style.display="block";
            // return false;
            var shadow = uid("shadow");

            var svgbasic = d3.select("svg.basic")
                            .attr("display", "none");

            var svgspecific = d3.select("svg.specific")
                            .attr("viewBox", [0, 0, width, height])
                            .style("font", "10px sans-serif");
            svgspecific.append("filter")
                .attr("id", shadow.id)
            .append("feDropShadow")
                .attr("flood-opacity", 0.3)
                .attr("dx", 0)
                .attr("stdDeviation", 3);

            var newNode = svgspecific.selectAll("g")
                                .data(d3.group(r, d => d.height))
                                .join("g")
                                    .attr("filter", shadow)
                                .selectAll("g")
                                .data(d => d[1])
                                .join("g")
                                    .attr("transform", d => `translate(${d.x0},${d.y0})`)
            
            newNode.append("title")
                .text(d => `${d.ancestors().reverse().map(d => d.data.name).join("/")}\n${format(d.value)}`);

            newNode.append("rect")
                .attr("id", d => (d.nodeUid = uid("node")).id)
                .attr("fill", d => color(d.height))
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0);

            newNode.append("clipPath")
                .attr("id", d => (d.clipUid = uid("clip")).id)
            .append("use")
                .attr("xlink:href", d => d.nodeUid.href);

            newNode.append("text")
                .attr("clip-path", d => d.clipUid)
            .selectAll("tspan")
            .data(d => d.data.name.split(/(?=[A-Z][^A-Z])/g).concat(format(d.value)))
            .join("tspan")
                .attr("fill-opacity", (d, i, nodes) => i === nodes.length - 1 ? 0.7 : null)
                .text(d => d);
            
            newNode.filter(d => d.children).selectAll("tspan")
                .attr("dx", 3)
                .attr("y", 13);

            newNode.filter(d => !d.children).selectAll("tspan")
                .attr("x", 3)
                .attr("y", (d, i, nodes) => `${(i === nodes.length - 1) * 0.3 + 1.1 + i * 0.9}em`);

            newNode.filter(d => d.children || !d.children)
                .attr("cursor", "pointer")

            svgspecific.attr("display", "inline")
        }
        
        var login=document.getElementById('login');
        var bg=document.getElementById('bg');

        // 2.点击"关闭",隐藏登陆窗口和遮盖层
        var closeBtn=document.getElementById('closeBtn');
        closeBtn.onclick=function(){
            login.style.display="none";
            bg.style.display="none";
            return false;
        }
        // 3.鼠标拖拽功能
        var login_title=document.getElementById('login-title');
        login_title.onmousedown=function(e){
            e = e || window.event;
            var x=e.pageX || e.clientX +(document.body.scrollLeft || document.documentElement.scrollLeft);
            var y=e.pageY || e.clientY +(document.body.scrollTop || document.documentElement.scrollTop);

            var boxX=login.offsetLeft;
            var boxY=login.offsetTop;

            var mouse_in_boxX=x-boxX;
            var mouse_in_boxY=y-boxY;

            document.onmousemove=function(e){
                var x=e.pageX || e.clientX +(document.body.scrollLeft || document.documentElement.scrollLeft);
                var y=e.pageY || e.clientY +(document.body.scrollTop || document.documentElement.scrollTop);

                login.style.left=x-mouse_in_boxX+256+'px';
                login.style.top=y-mouse_in_boxY-142+'px';
            }
        }

        login_title.onmouseup = function(){
            document.onmousemove=null;
        }
        
        // var svg = d3.select("svg"),
        //     width = +svg.attr("width"),
        //     height = +svg.attr("height");
        // console.log(width + "---" + height);
        // var fader = function(color) { return d3.interpolateRgb(color, "#fff")(0.2); },
        //     color = d3.scaleSequential([8, 0], d3.interpolateMagma)
        //     format = d3.format(",d");

        // var treemap = d3.treemap()
        //     .tile(d3.treemapResquarify)
        //     .size([width, height])
        //     .round(true)
        //     .paddingInner(1);

        // d3.json("data/newChina.json", function(error, data) {
        // if (error) throw error;

        // var root = d3.hierarchy(data)
        //     .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name; })
        //     .sum(sumByCount)
        //     .sort(function(a, b) { return b.height - a.height || b.value - a.value; });

        // treemap(root);

        // var cell = svg.selectAll("g")
        //     .data(root.leaves())
        //     .enter().append("g")
        //     .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });

        // cell.append("rect")
        //     .attr("id", function(d) { return d.data.id; })
        //     .attr("width", function(d) { return d.x1 - d.x0; })
        //     .attr("height", function(d) { return d.y1 - d.y0; })
        //     .attr("fill", function(d) { return color(d.parent.data.id); });

        // cell.append("clipPath")
        //     .attr("id", function(d) { return "clip-" + d.data.id; })
        //     .append("use")
        //     .attr("xlink:href", function(d) { return "#" + d.data.id; });

        // cell.append("text")
        //     .attr("clip-path", function(d) { return "url(#clip-" + d.data.id + ")"; })
        //     .selectAll("tspan")
        //     .data(function(d) { return d.data.name.split(/(?=[A-Z][^A-Z])/g); })
        //     .enter().append("tspan")
        //     .attr("x", 4)
        //     .attr("y", function(d, i) { return 13 + i * 10; })
        //     .text(function(d) { return d; });

        // cell.append("title")
        //     .text(function(d) { return d.data.id + "\n" + format(d.value); });

        // d3.selectAll("input")
        //     .data([sumBySize, sumByCount], function(d) { return d ? d.name : this.value; })
        //     .on("change", changed);

        // var timeout = d3.timeout(function() {
        //     d3.select("input[value=\"sumByCount\"]")
        //         .property("checked", true)
        //         .dispatch("change");
        // }, 2000);

        // function changed(sum) {
        //     timeout.stop();

        //     treemap(root.sum(sum));

        //     cell.transition()
        //         .duration(750)
        //         .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
        //     .select("rect")
        //         .attr("width", function(d) { return d.x1 - d.x0; })
        //         .attr("height", function(d) { return d.y1 - d.y0; });
        // }
        // });

        // function sumByCount(d) {
        // return d.children ? 0 : 1;
        // }

        // function sumBySize(d) {
        // return d.size;
        // }
    </script>

</body>
</html>



