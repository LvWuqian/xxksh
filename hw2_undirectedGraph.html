<html>
<head>
    <meta charset="utf-8">
    <title>图可视化与交互</title>
    <style type="text/css">
        circle {
            cursor: pointer;
            fill: #AEDD81;
        }

        circle.selected {
            fill: #EB7347;
        }

        line {
            stroke: #ccc;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }

        line.selected {
            stroke-dasharray: none;
            stroke: #EB7347;
        }
    
    </style>
</head> 
<body>
    <svg></svg>
    <script src='lib/d3.v3.min.js'></script>      
    <script>
        var edges = [
            {source: "0", target: "1", dis: 40},
            {source: "1", target: "2", dis: 60},
            {source: "2", target: "3", dis: 75},
            {source: "3", target: "4", dis: 90},
            {source: "4", target: "5", dis: 200},
            {source: "5", target: "6", dis: 100},
            {source: "2", target: "5", dis: 160},
            {source: "7", target: "8", dis: 80},
            {source: "8", target: "0", dis: 80},
            {source: "7", target: "1", dis: 80},
        ];

        var nodes = {};

        for(var i = 0; i < edges.length; i++){
            if(nodes[edges[i].source] == null)
                nodes[edges[i].source] = {name: edges[i].source}
            edges[i].source = nodes[edges[i].source]
            if(nodes[edges[i].target] == null)
                nodes[edges[i].target] = {name: edges[i].target}
            edges[i].target = nodes[edges[i].target]
        }

        //Floyd算法计算最短路径

        //1.初始化map
        var g = {}
        var p = {}
        for(var key in nodes){
            var gtmp = new Object()
            for(var inKey in nodes){
                gtmp[nodes[inKey]['name']] = Number.MAX_SAFE_INTEGER
            }
            g[nodes[key]['name']] = gtmp
            var ptmp = new Object()
            for(var inKey in nodes){
                ptmp[nodes[inKey]['name']] = nodes[inKey]['name']
            }
            p[nodes[key]['name']] = ptmp
            g[nodes[key]['name']][nodes[key]['name']] = 0
        }
        for(var i = 0; i < edges.length; i++){
            g[edges[i].source['name']][edges[i].target['name']] = edges[i].dis
            g[edges[i].target['name']][edges[i].source['name']] = edges[i].dis
        }
        //2.开始计算
        for(var kkey in g){
            for(var ikey in g){
                for(var jkey in g){
                    if (ikey != jkey && g[ikey][jkey] > (g[ikey][kkey] + g[kkey][jkey])){
                        //将权值和更新，路径也变为中转点
                        g[ikey][jkey] = g[ikey][kkey] + g[kkey][jkey];
                        p[ikey][jkey] = p[ikey][kkey];
                    }
                }
            }
        }

        nodes = d3.values(nodes);

        console.log(nodes)
        console.log(edges)

        var width = window.innerWidth
        var height = 1600;

        var force = d3.layout.force()
                    .nodes(nodes)                                                       //指定节点数组
                    .links(edges)                                                       //指定连线数组
                    .size([width, height])                                              //指定范围
                    .linkDistance(function(d) { return  d.dis; })                  //指定连线长度
                    .charge(-2000)                                                      //相互之间的作用力
                    .start();                                                           //开始作用
        
        //选中Svg设置高和宽
        var svg = d3.select("svg")
                    .attr("width",width)
                    .attr("height",height)

        //将边添加到Svg中
        var edgesInSvg = svg.selectAll("line")
                            .data(edges)
                            .enter()
                            .append("line")
                            .attr("id", function(d){
                                return "p_" + d.source.name + "_" + d.target.name
                            })
                            .attr("class", function(d){
                                return "p_" + d.source.name + " " + "p_" + d.target.name
                            });
                            // .style("stroke", "#ccc")
                            // .style("stroke-width", 2);

        //设置颜色色组
        var color = d3.scale.category20();

        var count = 0
        var selectedList = []

        //将节点添加到Svg中
        var nodesInSvg = svg.selectAll("circle")
                            .data(nodes)
                            .enter()
                            .append("circle")
                            .attr("id", function(d){
                                return "i_" + d.name
                            })
                            .attr("r",20)
                            // .style("fill", function(d,i){
                            //     return color(0);
                            // })
                            .on('mouseover', function(d) {
                                svg.selectAll("line." + "p_" + d.name)
                                    .style("stroke", "#26A65B")
                            })
                            .on('mouseout', function(d) {
                                // d3.selectAll('.divergence').remove();
                                svg.selectAll("line." + "p_" + d.name)
                                    .style("stroke", null)
                            })
                            .on('click', function(d) {
                                var click_circle = svg.selectAll("circle#" + "i_" + d.name)
                                if(click_circle.attr("class") != null && isStrInClass("selected", click_circle.attr("class"))){
                                    click_circle.classed("selected", false)
                                    var deletedIndex = selectedList.indexOf(d.name)
                                    selectedList.splice(deletedIndex, 1)　
                                    count -= 1
                                    svg.selectAll("line.selected")
                                            .classed("selected", false)
                                }
                                else{
                                    count += 1
                                    if(count == 2){
                                        //绘制路径
                                        console.log("绘制路径")
                                        selectedList.push(d.name)
                                        var path = calcPath(selectedList[0], selectedList[1])
                                        for(var i = 0; i < path.length - 1; i++){
                                            svg.select("line#p_" + path[i] + "_" + path[i+1])
                                                .classed("selected", true)
                                            svg.select("line#p_" + path[i+1] + "_" + path[i])
                                                .classed("selected", true)
                                        }
                                    }
                                    else if(count > 2){
                                        //删除绘制的路径并清空selectedList
                                        console.log("删除绘制的路径")
                                        svg.selectAll(".selected")
                                            .classed("selected", false)
                                        count = 1
                                        selectedList = [d.name]
                                    }
                                    else{
                                        selectedList.push(d.name)
                                    }
                                    click_circle.classed("selected", true)
                                }
                            })
                            .call(force.drag());         

        //将与节点相关的文字添加到Svg中
        var nodeTextsInSvg = svg.selectAll("text.node")
                            .data(nodes)
                            .enter()
                            .append("text")
                            .style("fill", "black")
                            .attr('class', 'node')
                            .attr("dx", 20)
                            .attr("dy", 8)
                            .text(function(d){
                                return d.name;
                            });

        //将与边相关的文字添加到Svg中
        var edgeTextsInSvg = svg.selectAll("text.edge")
                                .data(edges)
                                .enter().append("text")
                                .style("fill", "#ccc")
                                .attr('class', 'edge')
                                .attr("dx", 5)
                                .attr("dy", 2)
                                .text(function(d){
                                    return d.dis;
                                });
                            
        force.on("tick", function(){
            //刷新边
            edgesInSvg
                .attr("x1",function(d){ return d.source.x; })
                .attr("y1",function(d){ return d.source.y; })
                .attr("x2",function(d){ return d.target.x; })
                .attr("y2",function(d){ return d.target.y; });

            //刷新节点
            nodesInSvg
                .attr("cx",function(d){ return d.x; })
                .attr("cy",function(d){ return d.y; });

            //更新节点文字
            nodeTextsInSvg
                .attr("x", function(d){ return d.x; })
                .attr("y", function(d){ return d.y; });

            //更新边文字    
            edgeTextsInSvg
                .attr("x", function(d){ return (d.source.x + d.target.x) / 2; })
                .attr("y", function(d){ return (d.source.y + d.target.y) / 2; });
        });

        function isStrInClass(str, classStr) {
            let classArray = classStr.split(' ')
            return classArray.includes(str)
        }

        function calcPath(pa, pb) {
            var pathArray = [pa]
            tmp = pa
            while(tmp != pb){
                pathArray.push(p[tmp][pb])
                tmp = p[tmp][pb]
            }
            return pathArray
        }
    </script>

</body>
</html>  
