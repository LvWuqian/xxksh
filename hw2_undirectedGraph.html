<html>
<head>
    <meta charset="utf-8">
    <title>图可视化与交互</title>
    <style type="text/css">
        circle {
            cursor:pointer;
        }

        line {
            stroke: #ccc;
            stroke-width: 2;
        }
    
    </style>
</head> 
<body>
    <svg></svg>
    <script src='lib/d3.v3.min.js'></script>      
    <script>
        var edges = [
            {source: "0", target: "1", distance: 40},
            {source: "1", target: "2", distance: 60},
            {source: "2", target: "3", distance: 75},
            {source: "3", target: "4", distance: 90},
            {source: "4", target: "5", distance: 200},
            {source: "5", target: "6", distance: 100},
            {source: "2", target: "5", distance: 160},
            {source: "7", target: "8", distance: 80},
            {source: "8", target: "0", distance: 80},
            {source: "7", target: "1", distance: 80},
        ];
        
        var nodes = {};

        for(var i = 0; i < edges.length; i++){
            if(nodes[edges[i].source] == null)
                nodes[edges[i].source] = {name: edges[i].source}
            edges[i].source = nodes[edges[i].source]
            if(nodes[edges[i].target] == null)
                nodes[edges[i].target] = {name: edges[i].target}
            edges[i].target = nodes[edges[i].target]
        }

        nodes = d3.values(nodes);

        console.log(nodes)
        console.log(edges)

        var width = window.innerWidth
        var height = 2060;

        var force = d3.layout.force()
                    .nodes(nodes)                                                       //指定节点数组
                    .links(edges)                                                       //指定连线数组
                    .size([width, height])                                              //指定范围
                    .linkDistance(function(d) { return  d.distance; })                  //指定连线长度
                    .charge(-2000)                                                      //相互之间的作用力
                    .start();                                                           //开始作用
        
        //选中Svg设置高和宽
        var svg = d3.select("svg")
                    .attr("width",width)
                    .attr("height",height)

        //将边添加到Svg中
        var edgesInSvg = svg.selectAll("line")
                            .data(edges)
                            .enter()
                            .append("line")
                            .attr("class", function(d){
                                return "p_" + d.source.name + " " + "p_" + d.target.name
                            });
                            // .style("stroke", "#ccc")
                            // .style("stroke-width", 2);

        //设置颜色色组
        var color = d3.scale.category20();

        //将节点添加到Svg中
        var nodesInSvg = svg.selectAll("circle")
                            .data(nodes)
                            .enter()
                            .append("circle")
                            .attr("id", function(d){
                                return d.name
                            })
                            .attr("r",20)
                            .style("fill", function(d,i){
                                return color(i);
                            })
                            .on('mouseover', function(d) {
                                console.log("mouseover" + d.name)
                                svg.selectAll("line." + "p_" + d.name)
                                    .style("stroke", "black")
                            })
                            .on('mouseout', function(d) {
                                // d3.selectAll('.divergence').remove();
                                svg.selectAll("line." + "p_" + d.name)
                                    .style("stroke", null)
                            })
                            .call(force.drag());         

        //将与节点相关的文字添加到Svg中
        var nodeTextsInSvg = svg.selectAll("text.node")
                            .data(nodes)
                            .enter()
                            .append("text")
                            .style("fill", "black")
                            .attr('class', 'node')
                            .attr("dx", 20)
                            .attr("dy", 8)
                            .text(function(d){
                                return d.name;
                            });

        //将与边相关的文字添加到Svg中
        var edgeTextsInSvg = svg.selectAll("text.edge")
                                .data(edges)
                                .enter().append("text")
                                .style("fill", "#ccc")
                                .attr('class', 'edge')
                                .attr("dx", 5)
                                .attr("dy", 2)
                                .text(function(d){
                                    return d.distance;
                                });
                            
        force.on("tick", function(){
            //刷新边
            edgesInSvg
                .attr("x1",function(d){ return d.source.x; })
                .attr("y1",function(d){ return d.source.y; })
                .attr("x2",function(d){ return d.target.x; })
                .attr("y2",function(d){ return d.target.y; });

            //刷新节点
            nodesInSvg
                .attr("cx",function(d){ return d.x; })
                .attr("cy",function(d){ return d.y; });

            //更新节点文字
            nodeTextsInSvg
                .attr("x", function(d){ return d.x; })
                .attr("y", function(d){ return d.y; });

            //更新边文字    
            edgeTextsInSvg
                .attr("x", function(d){ return (d.source.x + d.target.x) / 2; })
                .attr("y", function(d){ return (d.source.y + d.target.y) / 2; });
        });
        
    </script>

</body>
</html>  
